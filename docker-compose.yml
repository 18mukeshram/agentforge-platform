# docker-compose.yml

# ============================================
# AgentForge - Local Development Stack
# ============================================
# Usage:
#   docker compose up        - Start all services
#   docker compose up api    - Start API only
#   docker compose up -d     - Start in background
#   docker compose down      - Stop all services
#   docker compose logs -f   - Follow logs
# ============================================

services:
  # ------------------------------
  # API Service (FastAPI)
  # ------------------------------
  api:
    build:
      context: ./apps/api
      dockerfile: Dockerfile
    container_name: agentforge-api
    ports:
      - "${API_PORT:-8000}:8000"
    environment:
      # Application
      - AGENTFORGE_APP_NAME=${APP_NAME:-AgentForge API}
      - AGENTFORGE_DEBUG=${API_DEBUG:-false}
      - AGENTFORGE_HOST=0.0.0.0
      - AGENTFORGE_PORT=8000
      # Authentication
      - AGENTFORGE_JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}
      # CORS
      - AGENTFORGE_CORS_ORIGINS=${CORS_ORIGINS:-http://localhost:3000}
      # Redis (future)
      - REDIS_URL=${REDIS_URL:-redis://redis:6379/0}
    healthcheck:
      test:
        [
          "CMD",
          "python",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - agentforge-network
    depends_on:
      redis:
        condition: service_healthy

  # ------------------------------
  # Web Service (Next.js)
  # ------------------------------
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
      args:
        - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL:-http://localhost:8000}
        - NEXT_PUBLIC_WS_URL=${NEXT_PUBLIC_WS_URL:-ws://localhost:8000}
    container_name: agentforge-web
    ports:
      - "${WEB_PORT:-3000}:3000"
    environment:
      - NODE_ENV=production
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    networks:
      - agentforge-network
    depends_on:
      api:
        condition: service_healthy

  # ------------------------------
  # Redis (Cache & Queue)
  # ------------------------------
  redis:
    image: redis:7-alpine
    container_name: agentforge-redis
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped
    networks:
      - agentforge-network
    command: redis-server --appendonly yes

# ------------------------------
# Networks
# ------------------------------
networks:
  agentforge-network:
    driver: bridge

# ------------------------------
# Volumes
# ------------------------------
volumes:
  redis-data:
    driver: local
